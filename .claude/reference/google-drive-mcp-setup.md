# Google Drive MCP — что уже сделано и что сделать вручную

## Уже сделано автоматически

- Установлены Python-зависимости (`pip install -r core/mcp/requirements-google-drive.txt`).
- В твоём `.mcp.json` уже добавлены серверы **google-drive-mcp** (личный Drive) и **google-drive-work-mcp** (рабочий Drive, credentials из `.claude/google-work/`).
- Файл `google_drive_token.json` добавлен в `.gitignore` (не попадёт в git).

Тебе остаётся только включить Drive API в Google Cloud и один раз войти в браузере.

---

## Что сделать вручную (пошагово)

### Шаг 1. Включить Google Drive API в Google Cloud

Сделать это нужно **для каждого аккаунта**, к которому хочешь подключать Drive (личный и/или рабочий).

#### 1.1. Открыть Google Cloud Console

1. В браузере открой: **https://console.cloud.google.com/**
2. Войди в нужный Google-аккаунт (для личного Drive — личный Gmail, для рабочего — рабочий, например roman.matsukatov@mindera.com).

#### 1.2. Выбрать проект

1. Вверху страницы, рядом с логотипом Google Cloud, нажми на **выпадающий список с названием проекта** (там может быть «Dex Calendar», «dex-calendar-486510» или другое имя).
2. Выбери проект, в котором у тебя уже настроен Google Calendar MCP (там уже есть OAuth и credentials).  
   Если такого проекта нет — создай новый: **New Project** → введи имя (например `Dex`) → **Create** → дождись создания и выбери этот проект в списке.

#### 1.3. Включить Google Drive API

1. В левом меню нажми **«APIs & Services»** (или «Интерфейсы и сервисы») → **«Library»** («Библиотека»).
2. В поиске вверху страницы введи: **Google Drive API**.
3. В результатах нажми на карточку **«Google Drive API»** (иконка с папкой/диском).
4. На странице API нажми кнопку **«Enable»** / **«Включить»**.
5. Дождись сообщения вроде «API enabled» — после этого Drive API включён для этого проекта.

Повтори шаги 1.1–1.3 для **второго аккаунта** (рабочего), если используешь **google-drive-work-mcp**: открой консоль под рабочим аккаунтом (или в том же проекте, если он общий) и убедись, что Drive API включён в выбранном проекте.

---

### Шаг 2. Первый вход (OAuth) для личного Drive (google-drive-mcp)

1. **Перезапусти Cursor** (полностью закрой и открой снова), чтобы подхватился MCP.
2. В чате с Dex напиши, например:  
   **«Покажи список файлов в корне моего Google Drive»**  
   или: **«gdrive_list_files»** (если умеешь вызывать инструменты по имени).
3. Должно открыться окно браузера с экраном входа Google.
4. Войди в **личный** Google-аккаунт (тот, чей Drive нужен для личного MCP).
5. Если появится экран «Google hasn’t verified this app»:
   - Нажми **«Advanced»** / **«Дополнительно»**.
   - Нажми **«Go to Dex (unsafe)»** / **«Перейти на Dex (небезопасно)»** (для личного приложения это нормально).
6. На экране разрешений отметь доступ к **Google Drive** (просмотр и загрузка файлов) и нажми **«Allow»** / **«Разрешить»**.
7. После успешного входа браузер может показать страницу «The authentication flow has completed» — можно закрыть вкладку.
8. В корне проекта Dex появится файл **`google_drive_token.json`** (или он будет в той же папке, что и `credentials.json`, если задан путь в `.env`). Больше входить для личного Drive не нужно.

---

### Шаг 3. Первый вход (OAuth) для рабочего Drive (google-drive-work-mcp)

Если используешь рабочий аккаунт отдельно:

1. В чате попроси что-то вроде: **«Покажи файлы в корне моего рабочего Google Drive»** (или явно укажи, что нужен рабочий Drive).
2. Откроется браузер — войди в **рабочий** Google-аккаунт (например roman.matsukatov@mindera.com).
3. Дай разрешение на доступ к Drive, как в шаге 2.
4. Токен сохранится в **`.claude/google-work/google_drive_token.json`** (путь задан в `.mcp.json` для `google-drive-work-mcp`).

---

### Шаг 4. Проверка

В чате попроси, например:

- «Найди в моём Drive документы с словом X»;
- «Покажи список папок в корне Drive»;
- «Прочитай содержимое документа [название]».

Если ответ приходит с данными из Drive — всё настроено.

---

## Если что-то пошло не так

| Проблема | Что проверить |
|----------|----------------|
| «Credentials file not found» | Файл `credentials.json` должен лежать в **корне** Dex или путь к нему задан в `.env`: `GOOGLE_DRIVE_CREDENTIALS_PATH=...`. Для рабочего MCP путь задаётся в `.mcp.json` и файл должен быть в `.claude/google-work/credentials.json`. |
| «API has not been used in project before» | В Google Cloud Console в **выбранном проекте** включи **Google Drive API** (шаг 1.3). |
| Браузер не открывается при первом запросе | Убедись, что после добавления MCP в `.mcp.json` ты **полностью перезапустил Cursor** (не только перезагрузка окна). |
| «Access blocked» / «This app isn’t verified» | На экране предупреждения нажми **Advanced** → **Go to [app name] (unsafe)** — для личного OAuth-клиента это ожидаемо. |

---

## Краткий чеклист

- [ ] В Google Cloud выбран нужный проект (тот же, что для Calendar, или новый).
- [ ] В этом проекте включён **Google Drive API** (APIs & Services → Library → Google Drive API → Enable).
- [ ] Cursor перезапущен после добавления MCP.
- [ ] Выполнен первый запрос к Drive в чате; в браузере выполнен вход и выдано разрешение.
- [ ] Файл токена создан: `google_drive_token.json` (личный) и/или `.claude/google-work/google_drive_token.json` (рабочий).

После этого все операции с Drive (поиск, чтение, список папок) можно делать через запросы в чате — вручную больше ничего настраивать не нужно.
